<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Reference Guide 1.3.x | Boot Plus</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/boot-plus/icon.png">
    <meta name="description" content="让开发者更关注业务">
    
    <link rel="preload" href="/boot-plus/assets/css/0.styles.7d8c9aaf.css" as="style"><link rel="preload" href="/boot-plus/assets/js/app.3b61fefb.js" as="script"><link rel="preload" href="/boot-plus/assets/js/2.7b2df435.js" as="script"><link rel="preload" href="/boot-plus/assets/js/11.2bb24d50.js" as="script"><link rel="prefetch" href="/boot-plus/assets/js/10.da92aae3.js"><link rel="prefetch" href="/boot-plus/assets/js/3.1426bb84.js"><link rel="prefetch" href="/boot-plus/assets/js/4.3af4e00b.js"><link rel="prefetch" href="/boot-plus/assets/js/5.76fc70b2.js"><link rel="prefetch" href="/boot-plus/assets/js/6.aa86b854.js"><link rel="prefetch" href="/boot-plus/assets/js/7.18197e31.js"><link rel="prefetch" href="/boot-plus/assets/js/8.8b0fd735.js"><link rel="prefetch" href="/boot-plus/assets/js/9.68234763.js">
    <link rel="stylesheet" href="/boot-plus/assets/css/0.styles.7d8c9aaf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/boot-plus/" class="home-link router-link-active"><!----> <span class="site-name">Boot Plus</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/boot-plus/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/boot-plus/guide/latest/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  最新
</a></li><li class="dropdown-item"><!----> <a href="/boot-plus/guide/1_2/" class="nav-link">
  1.2.x
</a></li></ul></div></div><div class="nav-item"><a href="/boot-plus/QA/" class="nav-link">
  Q&amp;A
</a></div><div class="nav-item"><a href="https://github.com/zhouxx/boot-plus/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更新日志
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zhouxx/boot-plus/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/boot-plus/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title">文档</span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/boot-plus/guide/latest/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  最新
</a></li><li class="dropdown-item"><!----> <a href="/boot-plus/guide/1_2/" class="nav-link">
  1.2.x
</a></li></ul></div></div><div class="nav-item"><a href="/boot-plus/QA/" class="nav-link">
  Q&amp;A
</a></div><div class="nav-item"><a href="https://github.com/zhouxx/boot-plus/blob/master/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更新日志
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/zhouxx/boot-plus/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Reference Guide 1.3.x</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/boot-plus/guide/latest/#part1-简介" class="sidebar-link">Part1 : 简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/boot-plus/guide/latest/#part2-新版本特性" class="sidebar-link">Part2 :  新版本特性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/boot-plus/guide/latest/#part3-起步" class="sidebar-link">Part3 : 起步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_3-1-系统要求" class="sidebar-link">3.1 系统要求</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_3-2-maven-依赖" class="sidebar-link">3.2 Maven 依赖</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_3-3-开发第一个应用" class="sidebar-link">3.3 开发第一个应用</a></li></ul></li><li><a href="/boot-plus/guide/latest/#part4-boot-plus-core" class="sidebar-link">Part4 : boot-plus-core</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#启动类com-appstart" class="sidebar-link">启动类com.AppStart</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#工具类-beanutils" class="sidebar-link">工具类：BeanUtils</a></li></ul></li><li><a href="/boot-plus/guide/latest/#part5-boot-plus-routing-datasource" class="sidebar-link">Part5 boot-plus-routing-datasource</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_5-1-配置多数据源" class="sidebar-link">5.1 配置多数据源</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_5-2-加密密码解析" class="sidebar-link">5.2 加密密码解析</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_5-3-动态添加-移除数据源" class="sidebar-link">5.3 动态添加/移除数据源</a></li></ul></li><li><a href="/boot-plus/guide/latest/#part6-boot-plus-web" class="sidebar-link">Part6 boot-plus-web</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_6-1-跨域支持" class="sidebar-link">6.1 跨域支持</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_6-2-json序列化之null值处理" class="sidebar-link">6.2 json序列化之null值处理</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_6-3-json序列化之数字格式化" class="sidebar-link">6.3 json序列化之数字格式化</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_6-4-json序列化之字典" class="sidebar-link">6.4 json序列化之字典</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_6-5-流处理" class="sidebar-link">6.5 流处理</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_6-6-参数校验" class="sidebar-link">6.6 参数校验</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_6-7-系统异常处理" class="sidebar-link">6.7 系统异常处理</a></li></ul></li><li><a href="/boot-plus/guide/latest/#part7-boot-plus-log" class="sidebar-link">Part7 boot-plus-log</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_7-1-对controller进行切面控制" class="sidebar-link">7.1 对Controller进行切面控制</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_7-2-管理日志级别" class="sidebar-link">7.2 管理日志级别</a></li></ul></li><li><a href="/boot-plus/guide/latest/#part8-boot-plus-swagger" class="sidebar-link">Part8 boot-plus-swagger</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/boot-plus/guide/latest/#part9-boot-plus-security" class="sidebar-link">Part9 boot-plus-security</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_9-1-jwt" class="sidebar-link">9.1 JWT</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_9-2-stateful-token-有状态token" class="sidebar-link">9.2 Stateful Token（有状态token)</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_9-3-如何开发" class="sidebar-link">9.3 如何开发</a></li></ul></li><li><a href="/boot-plus/guide/latest/#part10-boot-plus-mybatis-jpa" class="sidebar-link">Part10 boot-plus-mybatis-jpa</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-1-文件配置mapper扫描路径" class="sidebar-link">10.1 文件配置mapper扫描路径</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-2-crud自动加载sql" class="sidebar-link">10.2 Crud自动加载SQL</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-3-方法名称定义查询" class="sidebar-link">10.3 方法名称定义查询</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-4-方法名称定义查询-动态条件" class="sidebar-link">10.4 方法名称定义查询（动态条件）</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-5-自动关联查询" class="sidebar-link">10.5 自动关联查询</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-6-关联查询优化" class="sidebar-link">10.6 关联查询优化</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-7-关联查询-子查询-自定义" class="sidebar-link">10.7 关联查询(子查询)自定义</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-8-代码构建复杂查询" class="sidebar-link">10.8 代码构建复杂查询</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-9-主键支持" class="sidebar-link">10.9 主键支持</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-10-分页排序支持" class="sidebar-link">10.10 分页排序支持</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-11-默认值触发" class="sidebar-link">10.11 默认值触发</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-12-自定义数据库扩展" class="sidebar-link">10.12 自定义数据库扩展</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-13-pageable入参解析" class="sidebar-link">10.13 Pageable入参解析</a></li><li class="sidebar-sub-header"><a href="/boot-plus/guide/latest/#_10-14-mybatisjpastartedevent" class="sidebar-link">10.14 MybatisJpaStartedEvent</a></li></ul></li><li><a href="/boot-plus/guide/latest/#part11-boot-plus-generator" class="sidebar-link">Part11 boot-plus-generator</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/boot-plus/guide/latest/#part12-boot-plus-cache" class="sidebar-link">Part12 boot-plus-cache</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="reference-guide-1-3-x"><a href="#reference-guide-1-3-x" class="header-anchor">#</a> Reference Guide 1.3.x</h1> <h2 id="part1-简介"><a href="#part1-简介" class="header-anchor">#</a> Part1 : 简介</h2> <p>Boot Plus 是基于spring boot 的增强，但并未修改SpringBoot已有的功能，也就是说完全可以兼容使用SpringBoot的项目。可以任意使用其中一个模块的增强，而不必引入所有模块。让spring boot的使用者更好地关注于业务。</p> <p>主要增强以下几个方面：</p> <ul><li>dynamic datasource based on aop</li> <li>cache: spring cache enhancement</li> <li>web: json serialize enhancement, cros , validation enhancement</li> <li>log management online</li> <li>swagger(api online)</li> <li>mybatis extension：like jpa, but more smart</li> <li>security integration: more simple, support JWT &amp; Stateful Token</li></ul> <h2 id="part2-新版本特性"><a href="#part2-新版本特性" class="header-anchor">#</a> Part2 :  新版本特性</h2> <p>从1.3.0版本开始，做了一些模块上的重构：</p> <ul><li>移除了quartz的增强，你可以继续使用原来的版本，也可以使用xxl-job，它对使用者更友好</li> <li>将mybatis的增强模块合并至mybatis-jpa，让使用者更简化使用</li> <li>添加了对spring cache的增强，spring cache为我们提供了很好的缓存抽象，但未提供cache和tti和ttl配置，在此提供了基于caffeine和基于redis的tti、ttl配置增强</li> <li>同时也升级了spring boot 版本号至 <strong>2.3.5.RELEASE</strong> ，与 spring cloud  <strong>Hoxton.SR9</strong> 的版本号保持一致</li> <li>引用了官方的swagger starter 3.0.0</li></ul> <h2 id="part3-起步"><a href="#part3-起步" class="header-anchor">#</a> Part3 : 起步</h2> <h3 id="_3-1-系统要求"><a href="#_3-1-系统要求" class="header-anchor">#</a> 3.1 系统要求</h3> <p>Boot Plus 1.3.x 至少要求java1.8，Spring Boot 2.3.5.RELEASE.</p> <h3 id="_3-2-maven-依赖"><a href="#_3-2-maven-依赖" class="header-anchor">#</a> 3.2 Maven 依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alilitech<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>boot-plus-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.x<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_3-3-开发第一个应用"><a href="#_3-3-开发第一个应用" class="header-anchor">#</a> 3.3 开发第一个应用</h3> <h4 id="_3-3-1-创建pom"><a href="#_3-3-1-创建pom" class="header-anchor">#</a> 3.3.1 创建pom</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>myproject<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alilitech<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>boot-plus-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alilitech<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>boot-plus-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alilitech<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>boot-plus-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.x<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>你可以通过IDE指定启动类：<code>com.AppStart</code>来启动项目，也可以通过自定义启动类启动项目。</p> <h4 id="_3-3-2-创建一个可执行的jar"><a href="#_3-3-2-创建一个可执行的jar" class="header-anchor">#</a> 3.3.2 创建一个可执行的jar</h4> <p>需要添加 spring-boot-maven-plugin 至 pom.xml :</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">&gt;</span></span>com.AppStart<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>repackage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>至此，你已成功搭建和部署一个项目了。</p> <h2 id="part4-boot-plus-core"><a href="#part4-boot-plus-core" class="header-anchor">#</a> Part4 : boot-plus-core</h2> <p>提供了基于spring的依赖（没有web）。提供了以下功能：</p> <h3 id="启动类com-appstart"><a href="#启动类com-appstart" class="header-anchor">#</a> 启动类<code>com.AppStart</code></h3> <p>启动时更优雅地打印更多信息，包括本地地址，当前IP地址等。</p> <h3 id="工具类-beanutils"><a href="#工具类-beanutils" class="header-anchor">#</a> 工具类：<code>BeanUtils</code></h3> <p>更高效的深度拷贝。父类属性，组合属性都可一并拷贝。常用于Entity与DTO之间的对象拷贝，提高开发效率。</p> <div class="custom-block tip"><p class="custom-block-title">特性</p> <ul><li>源对象可以继承，可以组合。父类的属性、组合对象的属性可以一并拷贝至目标对象，无需二次赋值</li> <li>基于属性反射+Getter/Setter方法进行拷贝（理论上可以在拷贝的时候重写源对象属性的Getter方法从而转换成需要的值，但不建议这么做）</li> <li>反射比较耗时，第一次反射后，启用了缓存，避免频繁反射带来的开销</li> <li>忽略源对象的属性。如果源对象的属性（包括组合对象）可能会有属性重复，但实现拷贝时只需要一个属性，如果不忽略某些属性，可能会造成目标对象属性值的覆盖。(下面会详解如何忽略)</li></ul></div> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>源对象和目标对象属性名称和属性类型要完全一致，否则无法拷贝，造成值丢失</p></div> <div class="custom-block tip"><p class="custom-block-title">如何忽略源对象属性</p> <p>比如有个组合类如下</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> userId<span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    
    <span class="token class-name">Date</span> createdTime<span class="token punctuation">;</span>
    
    <span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">;</span>
    
    <span class="token comment">// getter &amp; setter</span>
    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> userInfoId<span class="token punctuation">;</span>
    
    <span class="token class-name">String</span> userId<span class="token punctuation">;</span>
    
    <span class="token class-name">Date</span> createdTime<span class="token punctuation">;</span>
    
    <span class="token comment">// getter &amp; setter</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>在用工具类拷贝的时候，UserInfo的createdTime可以会覆盖User对象的createdTime。</p> <p>想要忽略<code>UserInfo</code>的<code>createdTime</code>，可以如下使用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// simleName.property，注意大小写</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyPropertiesDeep</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;UserInfo.createdTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果想忽略<code>User</code>的<code>createdTime</code>，可以如下使用</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 源对象最外层的类名可以省略</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyPropertiesDeep</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;createdTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或</span>
<span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyPropertiesDeep</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">UserDTO</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;User.createdTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="part5-boot-plus-routing-datasource"><a href="#part5-boot-plus-routing-datasource" class="header-anchor">#</a> Part5 boot-plus-routing-datasource</h2> <p>动态数据源是指在项目里可以配置多个数据源，并且可以在不同的地方指定使用不同的数据源。</p> <p>此多数据源的实现未依赖于任何一个持久化的框架，所以一般于用于多库多service。想在同一个事务里操作多个数据源暂时无法实现。</p> <h3 id="_5-1-配置多数据源"><a href="#_5-1-配置多数据源" class="header-anchor">#</a> 5.1 配置多数据源</h3> <p>主数据源还和原来的方式一样，当未指定数据源或找不到指定的数据源时使用主数据源。主数据源的标识是<code>default</code>。
其它数据源标识要以<code>ds</code>开头，否则无法识别。配置方式和spring boot的方式一样。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/test
    <span class="token key atrule">username</span><span class="token punctuation">:</span> test
    <span class="token key atrule">password</span><span class="token punctuation">:</span> MyNewPass4<span class="token tag">!</span>
    <span class="token key atrule">ds-second</span><span class="token punctuation">:</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/test1
      <span class="token key atrule">username</span><span class="token punctuation">:</span> test
      <span class="token key atrule">password</span><span class="token punctuation">:</span> MyNewPass4<span class="token tag">!</span> 
</code></pre></div><p>代码里动态使用数据源的方式采用注解，一般在service层。比如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@DynamicSource</span><span class="token punctuation">(</span><span class="token string">&quot;ds-second&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-2-加密密码解析"><a href="#_5-2-加密密码解析" class="header-anchor">#</a> 5.2 加密密码解析</h3> <p>部分在配置文件里的密码是加密的，但在连数据的时候需要明文。所以提供了<code>EncryptPropertyResolver</code>来解析。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyEncryptPropertyResolver</span> <span class="token keyword">implements</span> <span class="token class-name">EncryptPropertyResolver</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supportResolve</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;spring.datasource.ds-second.password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-3-动态添加-移除数据源"><a href="#_5-3-动态添加-移除数据源" class="header-anchor">#</a> 5.3 动态添加/移除数据源</h3> <p>代码里可以动态地创建数据源，并添加到多数据源里。</p> <p>我们可以拿到数据源对象，判断是否是<code>DefaultDynamicDataSource</code>此类，可以调用此类的<code>addDataSource</code>方法。一般用于数据源实时动态修改切换。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//add datasource</span>
defaultDynamicDataSource<span class="token punctuation">.</span><span class="token function">addDataSource</span><span class="token punctuation">(</span>datasourceName<span class="token punctuation">,</span> datasourceUrl<span class="token punctuation">,</span> datasourceUsername<span class="token punctuation">,</span> datasourcePassword<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//remove datasource</span>
defaultDynamicDataSource<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>datasourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="part6-boot-plus-web"><a href="#part6-boot-plus-web" class="header-anchor">#</a> Part6 boot-plus-web</h2> <h3 id="_6-1-跨域支持"><a href="#_6-1-跨域支持" class="header-anchor">#</a> 6.1 跨域支持</h3> <p>跨域只需要在application.yml里配置：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">mvc</span><span class="token punctuation">:</span>
  <span class="token key atrule">cors</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>              
    <span class="token key atrule">path</span> <span class="token punctuation">:</span> <span class="token string">&quot;/**&quot;</span>               
    <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>        
    <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
    <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token number">3600</span>
    <span class="token key atrule">exposedHeaders</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> message
</code></pre></div><ul><li>enabled： 是否启用跨域</li> <li>path： 哪些URL可以跨域</li> <li>allowedOrigins： 哪些域名可以请求跨域，逗号隔开</li> <li>allowedMethods： 哪些方法可以跨域 POST, GET, PUT, DELETE, OPTIONS</li> <li>allowCredentials</li> <li>maxAge</li> <li>exposedHeaders：跨域时哪些头部信息返回</li></ul> <h3 id="_6-2-json序列化之null值处理"><a href="#_6-2-json序列化之null值处理" class="header-anchor">#</a> 6.2 json序列化之null值处理</h3> <p>对于部分null值，前端展示不友好，又不能直接去掉，若在业务里处理量大且麻烦，通过配置或注解可以解决此问题。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">mvc</span><span class="token punctuation">:</span>
  <span class="token key atrule">json</span><span class="token punctuation">:</span>
    <span class="token key atrule">defaultNull</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">defaultNullValue</span><span class="token punctuation">:</span> <span class="token string">&quot;-&quot;</span>
</code></pre></div><ul><li><p>defaultNull: 是否空字段（null）返回默认值，默认值如下：</p> <table><thead><tr><th>null字段类型</th> <th>默认值</th></tr></thead> <tbody><tr><td>String</td> <td>&quot;&quot;</td></tr> <tr><td>Array</td> <td>[]</td></tr> <tr><td>Object</td> <td>{}</td></tr> <tr><td>Date</td> <td>&quot;&quot;</td></tr> <tr><td>Double</td> <td>0.0</td></tr> <tr><td>Integer</td> <td>0</td></tr> <tr><td>Map</td> <td>{}</td></tr> <tr><td>BigDecimal</td> <td>0.0</td></tr></tbody></table></li> <li><p>defaultNullValue： 若配置了这个，则全部用此代替空字段（null）的返回默认值</p></li></ul> <p>以上都是对json的全局配置，我们对空值的默认值可以部分定义，如定义在某个需要序列化的类上：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@NullFormat</span><span class="token punctuation">(</span>defaultNull <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> defaultNullValue <span class="token operator">=</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>所有对null值默认值的处理不能对map等非常规bean起作用。如果是部分定义，只对当前类有效，其聚合的类无效。</p></blockquote> <p>若是对于同一个对象需要在不同线程里实现不同的效果，比如查看详情和修改详情对于null值处理不一样，使用如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">DefaultNullContextHolder</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//关闭此次请求/线程对null值序列化的处理</span>
</code></pre></div><h3 id="_6-3-json序列化之数字格式化"><a href="#_6-3-json序列化之数字格式化" class="header-anchor">#</a> 6.3 json序列化之数字格式化</h3> <p>业务上有很多逻辑运算，运算完了会产生结果，往往不同类型(如int、double)的数据返回的格式不一样，但实际上展示的时候需要统一保留两位或统一格式化。使用<code>@NumberFormat</code>注解：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@NumberFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;#,###,##0.00&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> amount<span class="token punctuation">;</span>
</code></pre></div><ul><li>pattern: 格式化格式，若使用了此样式，通过<code>DecimalFormat.format(pattern)</code>去格式化</li> <li>scale: 保留位数，默认是2</li> <li>round: 取舍模式，默认4舍五入，参考<code>BigDecimal</code>里的常量</li></ul> <h3 id="_6-4-json序列化之字典"><a href="#_6-4-json序列化之字典" class="header-anchor">#</a> 6.4 json序列化之字典</h3> <p>字典在数据库里表示不同的含义，从数据库里查出的是字典的key，与显示的值有一一对应关系。在实际展示给用户时必须是用户能理解的含义。以往的解决方式是通过在业务里单独处理或数据库查询的时候关联查询，若有新的字典含义可能还需要改代码，给项目带来了风险与不便。</p> <p>Boot Plus提供了解决方法：</p> <ul><li>定义字典和字典值。实现<code>DictCollector</code>并暴露给spring，<code>DictCollector</code>是字典收集器，可以收集所有的字典。可以定义多个字典收集器。</li> <li>使用<code>@DicFormat</code>注解。无需添加其它字段即可实现字段值的显示。
<ul><li>dictKey: 字典key，默认为当前属性的名称</li> <li>dictKeyToString: 字典key是否转String输出</li> <li>targetField: 目标属性名称，默认值是dicKey+&quot;Name&quot;</li> <li>defaultValue: 默认值，当字典里没有对应的值时，显示的字典值</li> <li>disableCache 禁用缓存（暂未实现）</li></ul></li></ul> <p>字典序列化默认采取了缓存策略，若字典key未找到，会从每个收集器再收集一次，故请在各个收集器里做好缓存策略，避免大面积将查询打到数据库。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>以上对json的扩展是基于jackson（spring mvc默认序列化）的，若在项目里未使用jackson序列化，无法扩展。</p></div> <h3 id="_6-5-流处理"><a href="#_6-5-流处理" class="header-anchor">#</a> 6.5 流处理</h3> <p>springmvc为我们提供了很好的文件上传的支持。但文件返回未实现。为些我们提供了更方便的文件下载和文件查看。</p> <ul><li>文件下载：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;boot/fileDownload&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractStreamingResponseBody</span><span class="token punctuation">&gt;</span></span> <span class="token function">fileDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileDownloadStreamingResponseBody</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;xx.pdf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fileName</span><span class="token punctuation">(</span><span class="token string">&quot;xxx.pdf&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">mediaType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_PDF<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">toResponseEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>文件查看：</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;boot/fileView&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractStreamingResponseBody</span><span class="token punctuation">&gt;</span></span> <span class="token function">fileView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileViewStreamingResponseBody</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;xx.pdf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">toResponseEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-6-参数校验"><a href="#_6-6-参数校验" class="header-anchor">#</a> 6.6 参数校验</h3> <h4 id="_6-6-1-校验"><a href="#_6-6-1-校验" class="header-anchor">#</a> 6.6.1 校验</h4> <p>校验是指对客户端请求的参数格式或逻辑校验，根据校验校验结果返回给客户端的不同信息。校验分两种：</p> <ul><li><p>手工校验</p> <p>手工校验是指在代码里的业务校验。校验不通过可以抛出校验异常。如：<code>throws new ValidateException(&quot;名称已存在&quot;)</code></p></li> <li><p>自动校验</p> <p>在自动映射的字段上，加上相关的注解，从而实现自动校验。如：<code>@NotEmpty(message=&quot;名称不能为空&quot;)</code></p></li></ul> <h4 id="_6-6-2-自定义校验处理器"><a href="#_6-6-2-自定义校验处理器" class="header-anchor">#</a> 6.6.2 自定义校验处理器</h4> <p>​	通过实现<code>com.alilitech.web.validate.ValidateHandler</code>接口，并实现处理验证异常。此处理器只能有一个，并暴露给spring。</p> <h3 id="_6-7-系统异常处理"><a href="#_6-7-系统异常处理" class="header-anchor">#</a> 6.7 系统异常处理</h3> <p>框架提供了全局默认异常处理：打印异常信息，在头部信息里返回<code>服务器内部错误</code></p> <p>也可以自定义异常处理，实现<code>com.alilitech.web.exception.ExceptionHandler</code>接口，并交给spring管理。</p> <h2 id="part7-boot-plus-log"><a href="#part7-boot-plus-log" class="header-anchor">#</a> Part7 boot-plus-log</h2> <p>集成了spring-boot-starter-actuator。</p> <h3 id="_7-1-对controller进行切面控制"><a href="#_7-1-对controller进行切面控制" class="header-anchor">#</a> 7.1 对Controller进行切面控制</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">aspect</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>可以控制开启切面是否开启，同时提供了切面控制扩展，可以打印日志或记录日志。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogOptService</span> <span class="token keyword">implements</span> <span class="token class-name">LogExtension</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeEnter</span><span class="token punctuation">(</span><span class="token class-name">Signature</span> signature<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//....</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">afterExit</span><span class="token punctuation">(</span><span class="token class-name">Signature</span> signature<span class="token punctuation">,</span> <span class="token class-name">Object</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//....</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-2-管理日志级别"><a href="#_7-2-管理日志级别" class="header-anchor">#</a> 7.2 管理日志级别</h3> <p>生产环境或测试环境有时候需要debug日志，等调试完后又关闭。访问<code>/log.html</code>在线管理日志级别。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>加了安全控制需要给相关人员赋于权限。相关的url包括<code>GET /management/logs</code>，<code>PUT /management/logs</code></p></div> <h2 id="part8-boot-plus-swagger"><a href="#part8-boot-plus-swagger" class="header-anchor">#</a> Part8 boot-plus-swagger</h2> <p>实现了在线API，主要实现以下功能：</p> <ul><li>集成swaggger</li> <li>统一授权配置</li> <li>每个接口添加参数配置</li> <li>简单导出API</li> <li>对Pageable进行参数改写</li> <li>在线UI（/api.html）</li></ul> <p>可以配置swagger相关配置，如：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">swagger</span><span class="token punctuation">:</span>
  <span class="token key atrule">title</span><span class="token punctuation">:</span> 接口文档
  <span class="token key atrule">description</span><span class="token punctuation">:</span> 这是在线生成的API文档
  <span class="token key atrule">version</span><span class="token punctuation">:</span> V1.0
  <span class="token key atrule">termsOfServiceUrl</span><span class="token punctuation">:</span>
  <span class="token key atrule">contactName</span> <span class="token punctuation">:</span> David
  <span class="token key atrule">contactUrl</span><span class="token punctuation">:</span> 
  <span class="token key atrule">contactEmail</span><span class="token punctuation">:</span> 
  <span class="token key atrule">license</span><span class="token punctuation">:</span>
  <span class="token key atrule">licenseUrl</span><span class="token punctuation">:</span>
  <span class="token key atrule">defaultIncludePattern</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token string">&quot;/api/.*&quot;</span>
  <span class="token key atrule">apiHost</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>                      <span class="token comment">#ui上测试操作的时候访问的实际url</span>
  <span class="token key atrule">global</span><span class="token punctuation">:</span>                                      <span class="token comment">#每个接口添加参数，在线API里，每个接口都会体现</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Authorization
      <span class="token key atrule">description</span><span class="token punctuation">:</span> 授权
      <span class="token key atrule">type</span><span class="token punctuation">:</span> string
      <span class="token key atrule">parameterType</span><span class="token punctuation">:</span> header
      <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">authorized</span><span class="token punctuation">:</span>                                  <span class="token comment">#统一处理授权</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Authorization
      <span class="token key atrule">in</span><span class="token punctuation">:</span> header
  <span class="token key atrule">authorizedIncludePattern</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;/api/.*&quot;</span>
</code></pre></div><p>defaultIncludePattern： 哪些url的API会在在线文档里显示</p> <p>apiHost：在线测试api时实际访问的API。由于代理映射问题，有时候访问html的地址和访问API的地址是不一致的</p> <p>global：每个接口添加参数，在线API里，每个接口都会体现。数组，可配置多个。</p> <p>authorized：统一授权，会在需要授权的API上加锁，显示需要授权。数组，可配置多个。</p> <p>authorizedIncludePattern： 哪个URL需要授权，逗号隔开</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在实际开发过程中如果有安全控制，也要将以下url分配相关权限：<code>GET /swagger-resources/**</code>, <code>GET /swagger-ui/**</code>, <code>GET /v2/**</code></p></div> <h2 id="part9-boot-plus-security"><a href="#part9-boot-plus-security" class="header-anchor">#</a> Part9 boot-plus-security</h2> <p>集成了spring scurity，但由于spring scurity比较复杂，使用起来比较繁琐，故做了一些减法，对常用的保留，对不常用的暂时去除。若需要其它功能的，请自行集成。</p> <p>此次集成主要实现了以下特性：</p> <ul><li>可快速实现授权与鉴权，无需关注复杂的各种过滤器</li> <li>集成JWT</li> <li>实现Stateful Token（有状态Token）</li> <li>支持多因素认证</li> <li>支持本地缓存和分布式缓存一键切换</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>注意：由于security模块引入spring cache，所以一定要配置cache名称：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
<span class="token key atrule">cache</span><span class="token punctuation">:</span>
 <span class="token key atrule">cache-names</span><span class="token punctuation">:</span>
 	<span class="token punctuation">-</span> security
</code></pre></div></div> <h3 id="_9-1-jwt"><a href="#_9-1-jwt" class="header-anchor">#</a> 9.1 JWT</h3> <p>在Spring Scurity基本上实现无状态的JWT Token。主要实现以下功能：</p> <ul><li>分离授权和鉴权</li> <li>用户可自定义扩展生成Token，校验Token</li> <li>用户可自定义扩展登陆成功，登陆失败，登出成功，根据登陆key查用户</li> <li>用户可自定义解析拿到Token，解析根据请求（uri）拿到资源（resource）对应的角色</li> <li>用户可自定义鉴权失败的返回</li> <li>登出Token黑名单功能（利用缓存，用户可自定义缓存）</li> <li>自动刷新Token(由于是无状态的，所以在Token快失效时，返回一个新的Token)</li></ul> <p>对于其它配置可以通过以下配置来实现</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token key atrule">token</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> JWT
    <span class="token key atrule">ignorePatterns</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;/*.ico&quot;</span>
        <span class="token key atrule">method</span><span class="token punctuation">:</span> GET
      <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;/css/**&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;/fonts/**&quot;</span>
    <span class="token key atrule">permitAllPatterns</span><span class="token punctuation">:</span> 
    <span class="token key atrule">permitAllUserNames</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> admin
    <span class="token key atrule">bizUserClassName</span><span class="token punctuation">:</span> 
    <span class="token key atrule">authenticationPrefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/authentication&quot;</span>
    <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
      <span class="token key atrule">secret</span><span class="token punctuation">:</span>                    <span class="token comment"># 加密串</span>
      <span class="token key atrule">timeoutMin</span><span class="token punctuation">:</span>                <span class="token comment"># Token超时, 单位：分钟</span>
      <span class="token key atrule">refreshSeconds</span><span class="token punctuation">:</span>            <span class="token comment"># Token还有多久失败时刷新Token， 单位：秒</span>
</code></pre></div><p>type：目前支持JWT，ST</p> <p><strong>ignorePatterns： 哪些url不需要授权和鉴权，这些url拿不到上下文</strong></p> <p><strong>permitAllPatterns：哪些url，所有用户都有权限</strong></p> <p><strong>permitAllUserNames： 哪些用户有全部url的权限</strong></p> <p><strong>authenticationPrefix: 认证（登录、登出）uri前缀</strong></p> <p>bizUserClassName:  需要存储的业务用户类全路径名，默认是BizUser.class.getName()</p> <p>jwt.secret: 加密串</p> <p>jwt.timeoutMin:  Token超时, 单位：分钟</p> <p>jwt.refreshSeconds: Token还有多久失败时刷新Token， 单位：秒</p> <h3 id="_9-2-stateful-token-有状态token"><a href="#_9-2-stateful-token-有状态token" class="header-anchor">#</a> 9.2 Stateful Token（有状态token)</h3> <p>在spring Scurity 基础上实现了有状态的token, token对应的用户信息在缓存里存储。</p> <p>配置如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token key atrule">token</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> ST
    <span class="token key atrule">ignorePatterns</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;/*.ico&quot;</span>
        <span class="token key atrule">method</span><span class="token punctuation">:</span> GET
      <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;/css/**&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;/fonts/**&quot;</span>
    <span class="token key atrule">permitAllPatterns</span><span class="token punctuation">:</span> 
    <span class="token key atrule">permitAllUserNames</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> admin
    <span class="token key atrule">bizUserClassName</span><span class="token punctuation">:</span> 
    <span class="token key atrule">authenticationPrefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/authentication&quot;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>两种风格只需要切换配置即可。</p></div> <h3 id="_9-3-如何开发"><a href="#_9-3-如何开发" class="header-anchor">#</a> 9.3 如何开发</h3> <ul><li><p>登录url</p> <p>${authenticationPrefix}/login</p></li> <li><p>登出uri</p> <p>${authenticationPrefix}/logout</p></li> <li><p>开发者扩展类<code>ExtensibleSecurity</code></p> <p><strong>用户用这个一个类可实现自定义认证授权与鉴权部分</strong></p> <ul><li><p>validTokenExtension: 校验token扩展，可自定义校验Token扩展，也可以刷新缓存期限</p></li> <li><p>loginSuccess: 登录成功处理</p></li> <li><p>loginFailure: 登录失败处理</p></li> <li><p>logoutSuccess: 登出成功处理</p></li> <li><p>loadUserByUsername:</p> <p>为用户名和密码方式的认证提供方法。</p> <p>根据用户名加载信息，包括用户名，密码。若需要鉴权的用户则需要加入角色信息</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span>maxAuth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">BizUser</span> bizUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BizUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bizUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roleCodes <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token class-name">BizUser</span> bizUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BizUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> roleCodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bizUser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>resolveToken 根据请求解析Token</p></li> <li><p>obtainResource 根据request（资源）获得关联的角色信息，以验证此用户是否有权限</p></li> <li><p>authorizationFailure 鉴权失败处理</p></li> <li><p>addVirtualFilterDefinitions</p> <p>我们可能有这样的需求，一个认证请求会同时验证好多数据，比如登陆时附带验证码的时候，我们需要先验证验证码，再验证用户名和密码（多因素认证，不是多次认证）。我们可以定义多个<code>VirtualFilterDefinition</code>，如：</p> <div class="language-java extra-class"><pre class="language-java"><code>virtualFilterDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">VirtualFilterDefinition</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">supportedPredicate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    		<span class="token comment">// 此filter是否支持验证判断</span>
            <span class="token class-name">AntPathRequestMatcher</span> requestMatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AntPathRequestMatcher</span><span class="token punctuation">(</span><span class="token string">&quot;/authentication/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">RequestMatcher<span class="token punctuation">.</span>MatchResult</span> matcher <span class="token operator">=</span> requestMatcher<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> servletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> matcher<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticationFunction</span><span class="token punctuation">(</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    		<span class="token comment">// 如何验证，验证失败时可以抛出AuthenticationException</span>
            <span class="token class-name">String</span> code <span class="token operator">=</span> servletRequest<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;验证码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> servletRequest<span class="token punctuation">,</span> servletResponse<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>	
    		<span class="token comment">// 此filter认证成功后，是否结束整个流程的认证</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">alias</span><span class="token punctuation">(</span><span class="token string">&quot;验证码验证&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//别名，在日志里会看到经过了哪些filter</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这些定义的filter会在用户名和密码认证的filter之前。用户名和密码的认证filter，只支持post请求。</p></div> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>VirtualFilterDefinition</code> 提供了构建Authentication的方法</p></div></li></ul></li> <li><p>authenticationExtension 授权原始框架扩展，默认情况下实现以下功能</p> <ul><li>开启跨域支持</li> <li>session管理禁用</li> <li>csrf 禁用</li></ul></li> <li><p>authorizationExtension 鉴权原始框架扩展，默认情况下实现以下功能</p> <ul><li>开启跨域支持</li> <li>session管理禁用</li> <li>csrf 禁用</li> <li>anonymous 禁用</li> <li>securityContext 禁用</li> <li>requestCache 禁用</li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>对于<code>authenticationExtension</code> 和<code>authorizationExtension</code>原始默认实现功能不符合要求，可完全覆盖默认实现</p></div> <h2 id="part10-boot-plus-mybatis-jpa"><a href="#part10-boot-plus-mybatis-jpa" class="header-anchor">#</a> Part10 boot-plus-mybatis-jpa</h2> <p>mybatis本身为我们做了很多事情，又不失灵活性，我们可以完全自主的方便的自定义sql。但有些通用的表数据增删改查也要我们来提供sql。为此市面上出了很多generator，代码生成器可以帮我们解决部分需求，但在表字段增加、修改、删减后又要重新执行一遍。如果我们已经有很多定制的开发了，则无法重新执行sql生成。为此我们为mybatis提供了增强，保留了原来的灵活性，更为开发者减少了工作量。由于此次增强实现了部分JPA规范，固命名为mybatis-jpa。</p> <h3 id="_10-1-文件配置mapper扫描路径"><a href="#_10-1-文件配置mapper扫描路径" class="header-anchor">#</a> 10.1 文件配置mapper扫描路径</h3> <p>首先增强了mybatis配置，传统的mybatis都需要搞个configuration类，然后写个<code>@mapperScan</code>, 感觉多此一举，这样也不能用统一的启动类。所以定义了在配置文件里配置mapper扫描</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token important">*:com/mapping/*.xml</span>
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.<span class="token important">**.domain</span>
  <span class="token key atrule">mapper-scan</span><span class="token punctuation">:</span>
    <span class="token key atrule">basePackages</span><span class="token punctuation">:</span> <span class="token string">&quot;com.**mapper,org.**mapper&quot;</span>     
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>mapper-scan.basePackages 多个路径，逗号隔开，支持通配符</p></div> <h3 id="_10-2-crud自动加载sql"><a href="#_10-2-crud自动加载sql" class="header-anchor">#</a> 10.2 Crud自动加载SQL</h3> <p>通用的crud再也不用我们自己手写或生成sql了，框架为我们提供了自动装载sql。</p> <p>实现了<code>Mapper</code>的接口或实现了<code>Mapper</code>的子接口(如<code>CrudMapper</code>等)的接口可以自动了生成对应的sql statement，无需重复编写。举例：</p> <p>定义mapper</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 泛型一定要定义，第一个指实体类的类型，第二指主键类型</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">CrudMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>定义实体类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;t_user&quot;</span><span class="token punctuation">)</span>  <span class="token comment">//表名</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Id</span>  										<span class="token comment">//指定主键</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span><span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>    <span class="token comment">//指定主键生成的规则</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
    
    <span class="token comment">// 字段名会自动映射为库里的dept_no，也就是驼峰（代码）转换成下划线（数据库）</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> deptNo<span class="token punctuation">;</span>

    <span class="token comment">// 也可强制指定表里的字段名称</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;memo1&quot;</span><span class="token punctuation">)</span>
  	<span class="token keyword">private</span> <span class="token class-name">String</span> memo1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-3-方法名称定义查询"><a href="#_10-3-方法名称定义查询" class="header-anchor">#</a> 10.3 方法名称定义查询</h3> <p>如果需要根据条件进行查询，可根据jpa规范实现，用方法名称定义查询条件，无需编写sql。如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 框架为你装载如下sql：
 * select ... from xxx where name = #{name} and age = #{age} order by name desc
 * 您只需要定义方法名称，无需写sql
 */</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByNameAndAgeOrderByNameDesc</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Integer</span> age<span class="token punctuation">)</span>
</code></pre></div><p>目前提供了以下几种查询：</p> <table><thead><tr><th>关键字</th> <th>查询效果</th></tr></thead> <tbody><tr><td>IsBetween;Between</td> <td>xx between val1 and val2</td></tr> <tr><td>IsNotBetween;NotBetween</td> <td>xx not between val1 and val2</td></tr> <tr><td>IsNotNull; NotNull</td> <td>xx is not null</td></tr> <tr><td>IsNull; Null</td> <td>xx is null</td></tr> <tr><td>IsLessThan; LessThan</td> <td>xx &lt; val</td></tr> <tr><td>IsLessThanEqual; LessThanEqual</td> <td>xx &lt;= val</td></tr> <tr><td>IsGreaterThan; GreaterThan</td> <td>xx &gt; val</td></tr> <tr><td>IsGreaterThanEqual; GreaterThanEqual</td> <td>xx &gt;= val</td></tr> <tr><td>IsBefore; Before</td> <td>xx &lt; val</td></tr> <tr><td>IsAfter; After</td> <td>xx &gt; val</td></tr> <tr><td>IsNotLike; NotLike</td> <td>xx not like %val%</td></tr> <tr><td>IsLike; Like</td> <td>xx like %val%</td></tr> <tr><td>IsStartingWith; StartingWith; StartsWith</td> <td>xx like val%</td></tr> <tr><td>IsEndingWith; EndingWith; EndsWith</td> <td>xx like %val</td></tr> <tr><td>IsNotContaining; NotContaining; NotContains</td> <td>xx not like %val%</td></tr> <tr><td>IsContaining; Containing; Contains</td> <td>xx like %val%</td></tr> <tr><td>IsTrue; True</td> <td>xx is true</td></tr> <tr><td>IsFalse; False</td> <td>xx is false</td></tr> <tr><td>IsNot; Not</td> <td>xx &lt;&gt; val</td></tr> <tr><td>Is; Equals</td> <td>xx = val</td></tr> <tr><td>In(传入list/set)</td> <td>xx in (?, ?, ? ....)</td></tr> <tr><td>NotIn(传入list/set)</td> <td>xx not in (?, ?, ? ....)</td></tr></tbody></table> <p>排序（在条件后面加OrderBy，可多个字段）：</p> <div class="language-java extra-class"><pre class="language-java"><code>findByXXOrderByXXXAsc
findByXXOrderByXXXDescAndXXX
</code></pre></div><p>查询条件扩展</p> <ul><li><div class="language- extra-class"><pre class="language-text"><code>find..By..
findByNameOrDeptNo
</code></pre></div></li> <li><div class="language- extra-class"><pre class="language-text"><code>get..By..
getByNameOrDeptNo
</code></pre></div></li> <li><div class="language- extra-class"><pre class="language-text"><code>query..By..
queryByNameOrDeptNo
</code></pre></div></li> <li><div class="language- extra-class"><pre class="language-text"><code>count..By..   //根据条件查询数量，返回数量
countByNameOrDeptNo
</code></pre></div></li> <li><div class="language- extra-class"><pre class="language-text"><code>exists..By.. //根据条件判断是否存在，返回boolean
existsByNameOrDeptNo
</code></pre></div></li> <li><div class="language- extra-class"><pre class="language-text"><code>delete..By..  //根据条件删除，返回删除的数量
deleteByNameOrDeptNo
</code></pre></div></li></ul> <h3 id="_10-4-方法名称定义查询-动态条件"><a href="#_10-4-方法名称定义查询-动态条件" class="header-anchor">#</a> 10.4 方法名称定义查询（动态条件）</h3> <p>在传统jpa里，若是实用jpa规范的接口，不能根据条件不同自定义不同条件的查询。但实际使用过程中，经常有若条件是空的，则查全部的。这个时候如果还是用条件匹配是不适合的。</p> <p>故为解决此问题，定义的注解<code>@IfTest</code>。举例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 
 * 此注解相当于mybatis里的动态sql标签
 * &lt;if test=&quot;name != null and name != ''&quot;&gt;and name = #{name}&lt;/if&gt;
 * &lt;if test=&quot;age &gt; 0&quot;&gt;and age = #{age}&lt;/if&gt;
 * &lt;if test=&quot;deptNo != null and deptNo != ''&quot;&gt;and dept_no = #{deptNo}&lt;/if&gt;
 */</span>
<span class="token annotation punctuation">@IfTest</span><span class="token punctuation">(</span>notEmpty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPageByNameAndAgeOrDeptNo</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@IfTest</span><span class="token punctuation">(</span>notEmpty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> conditions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;&gt; 0&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token class-name">Integer</span> age<span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token class-name">DeptNo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">请注意</p> <p>参数上定义了注解，则使用参数定义的注解。参数上没有定义的，则使用方法上的注解。</p></div> <div class="custom-block tip"><p class="custom-block-title">@IfTest详解</p> <ul><li><p><code>notEmpty</code></p> <ul><li>传入参数非集合时表示<code>xx != null and xx != ''</code></li> <li>传入参数是集合时表示<code>xx != null and xx.size &gt; 0</code></li></ul></li> <li><p><code>notNull</code></p> <p>转义成<code>xx != null</code></p></li> <li><p>其它条件</p> <p>必须只写判断条件，不用写元素，比如<code>&gt; 0</code></p></li></ul></div> <h3 id="_10-5-自动关联查询"><a href="#_10-5-自动关联查询" class="header-anchor">#</a> 10.5 自动关联查询</h3> <p>在查询时，往往会关联多表查询。但在使用jpa的时候，可以定义关联关系。通过自定义关联关系，可自动关联查询。mybatis-jpa也提供了关联查询，您只需要在实体类上定义关联关系即可，举例如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;t_user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> deptNo

    <span class="token annotation punctuation">@ManyToOne</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Dept</span> dept<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;t_dept&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Detp</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> deptId<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> deptNo<span class="token punctuation">;</span>
    
    <span class="token comment">//...</span>
    
    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;dept&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>目前提供三种关联</p> <ul><li><p>OneToOne</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
	
    <span class="token comment">//User表的userId和UserInfo表的userId一对一关联</span>
    <span class="token annotation punctuation">@OneToOne</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userInfoId<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
	
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ManyToOne</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Dict</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> dictId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
	
    <span class="token comment">//Dict表的doctId与DictVal表里的dictId关联</span>
   	<span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;dict&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DictVal</span><span class="token punctuation">&gt;</span></span> dictVals<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DictVal</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> dictValId<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> dictId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
	
    <span class="token comment">//DictVal的dictId与Dict主键关联</span>
   	<span class="token annotation punctuation">@ManyToOne</span>
	<span class="token keyword">private</span> <span class="token class-name">Dict</span> dict<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>ManyToMany</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>

    <span class="token comment">//定义中间表user_role</span>
    <span class="token comment">//定义User表的userId与中间表的userId字段关联</span>
    <span class="token comment">//定义Role表的roleId与中间表的roleId字段关联</span>
    <span class="token annotation punctuation">@ManyToMany</span>
	<span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_role&quot;</span><span class="token punctuation">,</span>
            joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inverseJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;roleId&quot;</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;roleId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Role</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Role</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> roleId<span class="token punctuation">;</span>

    <span class="token comment">//...</span>

    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;roles&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">请注意</p> <p>目前只有<strong>一层</strong>关联，并且只是做查询关联，并未做更新关联。</p></div> <div class="custom-block tip"><p class="custom-block-title">定义关联字段</p> <p>通过<code>@JoinColumn</code>注解可定义关联字段，若未定义，则默认是当前字段和关联类的主键关联</p></div> <div class="custom-block tip"><p class="custom-block-title">定义关联表</p> <p>当是ManyToMany的时候，才需要定义关联表，使用<code>@JoinTable</code>注解</p></div></li></ul> <h3 id="_10-6-关联查询优化"><a href="#_10-6-关联查询优化" class="header-anchor">#</a> 10.6 关联查询优化</h3> <p>若每次查询都需要关联查询，有时候消耗较大，会影响性能（N+1问题）。我们可以通过注解来实现，哪些需要，哪些不需要从而优化部分性能。如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Id</span>
	<span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
	
	<span class="token comment">//...</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> deptNo
	
	<span class="token annotation punctuation">@MappedStatement</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;findById&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>     <span class="token comment">//findById方法时不关联查询Dept</span>
	<span class="token annotation punctuation">@ManyToOne</span>
	<span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">,</span> referencedColumnName <span class="token operator">=</span> <span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">Dept</span> dept<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>@MappedStatement</code>有include(哪些需要关联)，exclude(哪些不需要关联)。填入的是对应的mapper的方法名称。</p> <p>若同时存在exclude，include。以exclude为准。</p></div> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>有一种情况，就是只是定义关联关系，并不是真正需要关联查询。可以只是加上注解<code>@MappedStatement</code>,并且不提供任何注解的值，这个时候就表示不会有任何查询去关联查子表。</p></div> <h3 id="_10-7-关联查询-子查询-自定义"><a href="#_10-7-关联查询-子查询-自定义" class="header-anchor">#</a> 10.7 关联查询(子查询)自定义</h3> <p>子查询时有时候需要定义排序，或者需要自定义部分字段过滤，比如有些删除是逻辑删除，子查询的时候我们不希望把已经删除的查出来。参考：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Id</span>
	<span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
	
	<span class="token comment">//...</span>
	
    <span class="token keyword">private</span> <span class="token class-name">String</span> deptNo<span class="token punctuation">;</span>
    
    <span class="token comment">// 关联查Dept的时候加条件 deleted = 0 order by dept_no</span>
	<span class="token annotation punctuation">@ManyToOne</span>
	<span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SubQuery</span><span class="token punctuation">(</span>
            predicates <span class="token operator">=</span> <span class="token annotation punctuation">@SubQuery.Predicate</span><span class="token punctuation">(</span>property <span class="token operator">=</span> <span class="token string">&quot;deleted&quot;</span><span class="token punctuation">,</span>condition <span class="token operator">=</span> <span class="token string">&quot;= 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            orders <span class="token operator">=</span> <span class="token annotation punctuation">@SubQuery.Order</span><span class="token punctuation">(</span>property <span class="token operator">=</span> <span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   
	<span class="token keyword">private</span> <span class="token class-name">Dept</span> dept<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>通过注解<code>@SubQuery</code> 可实现自定义子查询条件（固定条件，非动态），子查询排序（固定，非动态）</p></div> <h3 id="_10-8-代码构建复杂查询"><a href="#_10-8-代码构建复杂查询" class="header-anchor">#</a> 10.8 代码构建复杂查询</h3> <p>如果一直通过Mapper的方法来直接定义查询条件和排序，有时候会让方法变地太长，这样对于维护其实是不利的，我们提供了代码级构造复杂查询，通过继承<code>SpecificationMapper</code>接口，可以利用<code>Specification</code>构建复杂条件查询。参考：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// WHERE ( dept_no = ? AND ( age &gt; ? AND name like ?) ) order by name ASC</span>
userMapper<span class="token punctuation">.</span><span class="token function">findSpecification</span><span class="token punctuation">(</span><span class="token class-name">Specifications</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;002&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">nested</span><span class="token punctuation">(</span>builder <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">greaterThan</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//page and order</span>
testUserMapper<span class="token punctuation">.</span><span class="token function">findPageSpecification</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> <span class="token class-name">Specifications</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;002&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或者自定义构建</p> <div class="language-java extra-class"><pre class="language-java"><code>userMapper<span class="token punctuation">.</span><span class="token function">findSpecification</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> query<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">PredicateExpression</span> expression <span class="token operator">=</span> cb<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;002&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cb<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token string">&quot;createTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PredicateExpression</span> expression1 <span class="token operator">=</span> cb<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">lessThan</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
            query<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expression1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            query<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">asc</span><span class="token punctuation">(</span><span class="token string">&quot;deptNo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cb<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-9-主键支持"><a href="#_10-9-主键支持" class="header-anchor">#</a> 10.9 主键支持</h3> <p>目前支持四种主键类型：自增（IDENTITY）、序列（SEQUENCE）、UUID（32位），SNOWFLAKE（雪花）。可如下定义：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span><span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_10-9-1-雪花算法主键"><a href="#_10-9-1-雪花算法主键" class="header-anchor">#</a> 10.9.1 雪花算法主键</h4> <p>关于雪花算法的主键配置如下：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">snowflake</span><span class="token punctuation">:</span>
    <span class="token key atrule">group-id</span><span class="token punctuation">:</span> <span class="token number">1</span>                         <span class="token comment"># 组id</span>
    <span class="token key atrule">worker-id</span><span class="token punctuation">:</span> <span class="token number">1</span>					    <span class="token comment"># 工作id</span>
    <span class="token key atrule">time-callback-strategy</span><span class="token punctuation">:</span> waiting     <span class="token comment"># 时间回拨策略（等待，备用工作id，修改偏移量）</span>
    <span class="token key atrule">max-back-time</span><span class="token punctuation">:</span> <span class="token number">1</span>                    <span class="token comment"># 最大可回拨时间，超出则报异常，表示生成id失败</span>
    <span class="token key atrule">extra-worker-id</span><span class="token punctuation">:</span> <span class="token number">2</span>                  <span class="token comment"># 备用工作id 只有回拨策略是备用工作id时，必须配置此属性</span>
    <span class="token key atrule">offset</span><span class="token punctuation">:</span>                             <span class="token comment"># 默认时间偏移量</span>
</code></pre></div><p>雪花算法的主键为时间回拨提供了3种处理方式</p> <ul><li><p>WAITING</p> <p>等待回拨时间，此策略适用于客户端允许时间等待的情况</p></li> <li><p>备用workerId</p> <p>如果workerId有多余的情况，可以启用备用id。备用id只是在时间段重叠部分换了备用workerId，这样备用workerId变成了主workerId，原来的主workerId变成备用workerId。注意此策略不适应用于回拨时间段在同一区间的，若两次回拨的时间区间重叠了，这时候两个workerId都被使用过了，会造成主键重复</p></li> <li><p>修改偏移量</p> <p>我们设计时间偏移量，在取得当前时间后，会减去偏移量，从而达到较小数值，从而让ID的生成时间更久。时间回拨，无非就是让最终生成的ID变小了，导致ID重复，我们可以考虑修改偏移量来达到ID变大。让偏移量减去回拨时间区间，从而让最终的ID变成和原来的轨迹。</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>时间偏移量的修改只是在内存中修改了。如果项目重启了，请确认项目的重启间隔大于回拨时间。</p></div> <p>由于现在很多项目使用云原生，会导致项目不间断，也就是说没有重启间隔时间。我们提供了外部存储时间偏移量接口<code>OffsetRepository</code>,在实现接口后让spring管理，示例如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyOffsetRepository</span> <span class="token keyword">implements</span> <span class="token class-name">OffsetRepository</span><span class="token punctuation">,</span> <span class="token class-name">EnvironmentAware</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Environment</span> env<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">saveOffset</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> entityClass<span class="token punctuation">,</span> <span class="token class-name">Long</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 由于是多应用，我们可以采用应用名称来区分不同项目，也可以采用`groupId+workerId`来区分</span>
        <span class="token class-name">String</span> applicationName <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;spring.application.name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>applicationName <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> entityClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> entityClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> applicationName <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;spring.application.name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> o <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>applicationName <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> entityClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>env <span class="token operator">=</span> env<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></li></ul> <h4 id="_10-9-2-自定义主键生成规则"><a href="#_10-9-2-自定义主键生成规则" class="header-anchor">#</a> 10.9.2 自定义主键生成规则</h4> <p>现阶段生成id的方式特别多，特别是基于分布式的情况，所以提供了扩展给使用者，让使用者自定义id生成规则。</p> <p>通过实现<code>KeyGenerator#generate</code>，然后在定义id生成规则的时候指定generatorClass：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 定义主键生成类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyGenerator</span> <span class="token keyword">implements</span> <span class="token class-name">KeyGenerator</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 指定用这个类生成这个主键，在插入的时候会自动调用此类的generate方法</span>
<span class="token annotation punctuation">@Id</span>
<span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>generatorClass <span class="token operator">=</span> <span class="token class-name">MyGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-10-分页排序支持"><a href="#_10-10-分页排序支持" class="header-anchor">#</a> 10.10 分页排序支持</h3> <p>已经实现了自动物理分页。</p> <p>在方法里传<code>Page</code>， <code>Sort</code>即可。如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">findPageByName</span><span class="token punctuation">(</span><span class="token class-name">Page</span> page<span class="token punctuation">,</span> <span class="token class-name">Sort</span> sort， <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>返回的total也在此对象里，拿到即可。</p> <p>排序传入<code>Sort</code>对象，<code>Sort</code>对象可以构造多个排序</p> <ul><li>如果只是分页，不查询总数，可设置<code>page.setSelectCount(false)</code></li> <li>为应对多数据源，可手动设置DatabaseType：<code>page.setDatabaseType(databaseType)</code></li> <li>如果想自动根据不同数据源设置不同的type，可在配置里设置<code>mybatis.page.autoDialect=true</code></li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>​	若使用传入参数排序，则不要用接口定义的方式定义排序。只能选一种。</p> <p>​	分页中，只对框架生成的sql提供了count sql优化，自定义的sql暂未做解析优化</p></div> <h3 id="_10-11-默认值触发"><a href="#_10-11-默认值触发" class="header-anchor">#</a> 10.11 默认值触发</h3> <p>默认值触发是指类似于触发器，在我们插入或更新时候指定某些字段的默认值。而不需要我们每次处理的时候去设置值。</p> <p>默认值分两种：java代码、系统函数。java代码可直接定义，也可定义类和方法。系统函数分直接替换占位。</p> <p>可使用<code>@TriggerValue</code>注解实现。如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@TriggerValue</span><span class="token punctuation">(</span>triggers <span class="token operator">=</span> <span class="token annotation punctuation">@Trigger</span><span class="token punctuation">(</span>triggerType <span class="token operator">=</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">,</span> valueType <span class="token operator">=</span> <span class="token class-name">TriggerValueType<span class="token punctuation">.</span>DatabaseFunction</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;sysdate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

<span class="token annotation punctuation">@TriggerValue</span><span class="token punctuation">(</span>triggers <span class="token operator">=</span> <span class="token annotation punctuation">@Trigger</span><span class="token punctuation">(</span>triggerType <span class="token operator">=</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>UPDATE<span class="token punctuation">,</span> valueType <span class="token operator">=</span> <span class="token class-name">TriggerValueType<span class="token punctuation">.</span>JavaCode</span><span class="token punctuation">,</span> valueClass <span class="token operator">=</span> <span class="token class-name">TestSeqService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> methodName <span class="token operator">=</span> <span class="token string">&quot;getDate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-12-自定义数据库扩展"><a href="#_10-12-自定义数据库扩展" class="header-anchor">#</a> 10.12 自定义数据库扩展</h3> <p>不可能实现所有的关系型数据库，故将数据库的扩展功能交给使用者。</p> <p>通过实现<code>MybatisJpaConfigurer#addDatabase</code>方法，添加定制化数据库，同时需要定义分页<code>PaginationDialect</code>。若有序列生成id的方法，也需实现<code>KeySqlGenerator</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addDatabase</span><span class="token punctuation">(</span><span class="token class-name">DatabaseRegistry</span> databaseRegistry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    databaseRegistry<span class="token punctuation">.</span><span class="token function">addDatabase</span><span class="token punctuation">(</span><span class="token class-name">DatabaseType</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;CustomDatabaseId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">paginationDialect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyPaginationDialect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">keySqlGenerator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyPaginationDialect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_10-13-pageable入参解析"><a href="#_10-13-pageable入参解析" class="header-anchor">#</a> 10.13 Pageable入参解析</h3> <p>让排序传入更简单更优雅。若集成swagger，则可以通过swagger-ui查看具体的参数信息</p> <h3 id="_10-14-mybatisjpastartedevent"><a href="#_10-14-mybatisjpastartedevent" class="header-anchor">#</a> 10.14 MybatisJpaStartedEvent</h3> <p>提供一个Event，在jpa加载完成后发布一个事件。可以利用此事件执行一些后置方法。</p> <p>比如我们需要在框架启动后去调用jpa构建的statement，不然会报找不到statement的异常</p> <h2 id="part11-boot-plus-generator"><a href="#part11-boot-plus-generator" class="header-anchor">#</a> Part11 boot-plus-generator</h2> <p>这是一个maven插件，方便生成实体类和mapper，使用方式如下：</p> <ul><li><p>在需要生成代码的项目或模块里，定义一个xml文件<code>generate.xml</code>：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>datasource</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>jdbc:mysql://localhost:3306/test?characterEncoding=utf-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driverName</span><span class="token punctuation">&gt;</span></span>com.mysql.jdbc.Driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>driverName</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>username</span><span class="token punctuation">&gt;</span></span>root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>username</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">&gt;</span></span>root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>datasource</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>projectPath</span><span class="token punctuation">&gt;</span></span>src/main/java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>projectPath</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packageName</span><span class="token punctuation">&gt;</span></span>com.alilitech<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packageName</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tables</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">tableName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>t_user<span class="token punctuation">&quot;</span></span> <span class="token attr-name">domainName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>User<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- 可以多个table --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tables</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li></ul> <p>​		将此文件置于classpath下，注意此项目本身要有相关的数据库连接驱动，否则无法连接数据库。</p> <ul><li><p>配置插件</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alilitech<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>boot-plus-generator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alilitech<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>boot-plus-mybatis-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>运行插件</p></li></ul> <h2 id="part12-boot-plus-cache"><a href="#part12-boot-plus-cache" class="header-anchor">#</a> Part12 boot-plus-cache</h2> <p>spring cache为我们提供了多个缓存的抽象，我们只要调用cacheManager就可以操作不同的缓存，但并未提供缓存的tti、ttl的抽象。本模块致力于提供缓存的tti、ttl抽象。目前支持caffeine和redis。这样我们在本地开发的时候可以使用caffeine，不需要依赖redis。上生产可以切换成基于redis分布式缓存。</p> <p>操作缓存的类<code>CacheTemplate</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/boot-plus/assets/js/app.3b61fefb.js" defer></script><script src="/boot-plus/assets/js/2.7b2df435.js" defer></script><script src="/boot-plus/assets/js/11.2bb24d50.js" defer></script>
  </body>
</html>
